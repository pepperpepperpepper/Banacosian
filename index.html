<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dictation - Ear Training</title>
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
            <div class="container ui-card">
        <h1>üéπ Dictation</h1>
        
        
        
        <div class="game-controls">
            <div class="main-action-row">
                <button class="control-btn ui-pill" id="newSequenceBtn">Start Game</button>
                <button class="control-btn ui-pill" id="playSequenceBtn" disabled>Replay</button>
                <button class="control-btn ui-pill" id="settingsToggle" aria-expanded="false" aria-controls="settingsPanel" aria-haspopup="true">Settings</button>
            </div>
            <div class="settings-row" id="settingsPanel" hidden>
                <select id="difficulty" class="select-pill ui-pill">
                    <option value="2">2 notes</option>
                    <option value="3" selected>3 notes</option>
                    <option value="4">4 notes</option>
                    <option value="5">5 notes</option>
                </select>
                <select id="tonicSelect" class="select-pill ui-pill" aria-label="Select tonic"></select>
                <select id="scaleType" class="select-pill ui-pill">
                    <option value="diatonic" selected>Diatonic</option>
                    <option value="chromatic">Chromatic</option>
                </select>
                <select id="dictationType" class="select-pill ui-pill">
                    <option value="melodic" selected>Dictation Mode: Melodic</option>
                    <option value="harmonic">Dictation Mode: Harmonic</option>
                </select>
                <select id="inputMode" class="select-pill ui-pill">
                    <option value="keyboard" selected>Input: Keyboard</option>
                    <option value="staff">Input: Staff</option>
                </select>
                <select id="mode" class="select-pill ui-pill">
                    <option value="ionian" class="mode-option-primary" selected>Ionian</option>
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="aeolian" class="mode-option-primary">Aeolian</option>
                    <option value="locrian">Locrian</option>
                    <option value="chromatic">Chromatic</option>
                    <option value="half-whole">Half-Whole</option>
                    <option value="whole-half">Whole-Half</option>
                    <option value="whole-tone">Whole Tone</option>
                    <option value="melodic-minor">Melodic Minor</option>
                    <option value="dorian-b2">Dorian b2</option>
                    <option value="lydian-augmented">Lydian Augmented</option>
                    <option value="lydian-dominant">Lydian Dominant</option>
                    <option value="mixolydian-b6">Mixolydian b6</option>
                    <option value="locrian-sharp2">Locrian #2</option>
                    <option value="altered">Altered (Super Locrian)</option>
                    <option value="harmonic-minor">Harmonic Minor</option>
                    <option value="locrian-sharp6">Locrian #6</option>
                    <option value="ionian-sharp5">Ionian #5</option>
                    <option value="dorian-sharp4">Dorian #4</option>
                    <option value="phrygian-dominant">Phrygian Dominant</option>
                    <option value="lydian-sharp2">Lydian #2</option>
                    <option value="super-locrian-bb7">Super Locrian bb7</option>
                </select>
                <select id="disabledKeysStyle" class="select-pill ui-pill" aria-label="Disabled keys appearance">
                    <option value="hatched" selected>Disabled Keys: Hatched</option>
                    <option value="invisible">Disabled Keys: Invisible</option>
                </select>
                <select id="answerRevealMode" class="select-pill ui-pill" aria-label="Correct answer replay setting">
                    <option value="show" selected>Correct Answer Replay: Show</option>
                    <option value="skip">Correct Answer Replay: Skip</option>
                </select>
                <select id="timbreSelect" class="select-pill ui-pill" aria-label="Select timbre"></select>
                <select id="staffFont" class="select-pill ui-pill" aria-label="Select staff font"></select>
            </div>
        </div>

        <div class="status-area">
            <div class="feedback" id="feedback"></div>
            
            <div id="sequenceDisplay" class="sequence-display"></div>
            
            <div id="userSequenceDisplay" class="sequence-display" style="margin-top: 10px;"></div>
        </div>

        <div
            id="staff-vexflow"
            class="vexflow-display interaction-draggable"
            role="img"
            aria-label="Rendered musical staff"
            data-staff-min-width="240"
            data-staff-base-height="120"
            data-staff-scale="3"
        ></div>

        <div class="staff-input-controls" id="staffInputControls" hidden>
            <button class="control-btn ui-pill" id="staffSubmitBtn" disabled>Submit</button>
        </div>

        <div class="piano" id="pianoContainer">
            <div class="piano-keys" aria-label="Interactive piano keyboard"></div>
        </div>

<div class="timer-display">
            <div class="timer" id="timer">00:00</div>
            <div class="round-progress">
                Score: <span id="correct">0</span> / <span id="total">0</span>
                (<span id="percentage">0</span>%)
            </div>
            <div class="round-accuracy">
                Current Accuracy: <span id="currentAccuracy">0%</span>
            </div>
        </div>
        <!-- History / data controls (temporarily disabled)
        <div class="data-controls">
            <div class="data-row">
                <button class="control-btn ui-pill" id="showHistoryBtn">üìä View History</button>
                <button class="control-btn ui-pill" id="saveDataBtn">üíæ Save to Drive</button>
            </div>
            <div class="data-row">
                <button class="control-btn ui-pill" id="loadDataBtn">üìÇ Load from Drive</button>
            </div>
        </div>

        <div id="historyModal" class="modal">
            <div class="modal__dialog">
                <div class="modal__header">
                    <h2 class="modal__title">üìä Session History</h2>
                    <button id="closeHistoryBtn" class="ui-pill modal__close" type="button">‚úï Close</button>
                </div>
                <div id="historyContent" class="modal__content"></div>
            </div>
        </div>
        -->

        <div class="data-controls">
            <div class="data-row">
                <a class="control-btn ui-pill" href="intervals-runner/">üèÉ Interval Runner</a>
            </div>
        </div>

        <div class="instructions">
            <strong>How to play:</strong><br>
            1. Choose sequence length and click "Start Game"<br>
            2. Listen carefully to the melody or chord<br>
            3. Play it back on your selected input method<br>
            4. Get feedback after completing the sequence<br>
            5. Use "Replay" to hear the original again
        </div>
    </div>
    <!-- Modular JavaScript files -->
    <script>
        (function loadAppScriptsSequentially() {
            const cacheTag = window.__EarCacheTag || (window.__EarCacheTag = `cb=${Date.now().toString(36)}`);
            const scripts = [
                '/js/shared/blockContextMenu.js',
                'https://cdn.jsdelivr.net/npm/tonal@4.14.2/browser/tonal.min.js',
                'js/modules/Audio.js',
                'js/modules/AudioPreview.js',
                'js/modules/MusicTheory.js',
                'js/modules/Keyboard.js',
                'js/modules/StaffNoteUtils.js',
                'js/modules/StaffDisplayRuntime.js',
                'js/modules/StaffInteractionBridge.js',
                'js/modules/StaffSequenceManager.js',
                'js/modules/StaffPlaybackController.js',
                'js/modules/StaffInputBindings.js',
                'js/modules/StaffFeedbackController.js',
                'js/modules/StaffSharedUtils.js',
                'js/modules/Staff.js',
                'js/modules/StaffInputController.js',
                'js/modules/Scoring.js',
                'js/modules/SettingsStore.js',
                'js/modules/MidiInput.js',
                'js/modules/Storage.js',
                'js/modules/RoundPhaseController.js',
                'js/modules/UI.js',
                'js/modules/DictationUIController.js',
                'js/modules/DictationSettings.js',
                'js/modules/DictationSettingsHandlers.js',
                'js/modules/DictationSequenceController.js',
                'js/modules/DictationStaffBridge.js',
                'js/modules/DictationInputManager.js',
                'js/MelodicDictation.js'
            ];
            const isAbsolute = (src) => /^https?:\/\//i.test(src);
            const target = document.body || document.head;
            if (!target) return;

            function appendNext(index) {
                if (index >= scripts.length) return;
                const originalSrc = scripts[index];
                if (typeof originalSrc !== 'string' || originalSrc.trim() === '') {
                    appendNext(index + 1);
                    return;
                }
                const src = isAbsolute(originalSrc)
                    ? originalSrc
                    : `${originalSrc}${originalSrc.includes('?') ? '&' : '?'}${cacheTag}`;
                const script = document.createElement('script');
                script.src = src;
                script.async = false;
                script.onload = () => appendNext(index + 1);
                script.onerror = (event) => {
                    console.error('[ScriptLoader] Failed to load script:', src, event);
                    appendNext(index + 1);
                };
                target.appendChild(script);
            }

            appendNext(0);
        })();
    </script>
</body>
</html>
